<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Manage Booking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body{
      font-family:'Inter',sans-serif;
      background:linear-gradient(180deg,#0b0b0b,#161616);
      color:#ffffff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .container{ padding:40px }
    .card{
      background: rgba(255,255,255,0.04) !important;
      border: 1px solid rgba(255,255,255,0.12) !important;
      color: #ffffff !important;
    }
    .card h5, .card h4, .card h3 { color: #ffffff !important; }
    .text-muted{ color: rgba(255,255,255,0.82) !important; }
    .btn-outline-light{ color: #fff !important; border-color: rgba(255,255,255,0.22) !important; }
    .btn-book-primary, .btn-danger { color: #fff !important; }
    .alert-warning{ background: rgba(255,193,7,0.08); color: #fff; border-color: rgba(255,193,7,0.2); }
    @media (max-width: 600px) { .container{ padding:20px } }
  </style>
</head>
<body>
  <div class="container">
    <a href="my-bookings.html" class="btn btn-outline-light mb-3">Back to Bookings</a>
    <h2>Manage Booking</h2>
    <div id="manageDetails" class="mt-3">
      <p>Loadingâ€¦</p>
    </div>
  </div>
  <script>
    function getQueryParam(name){const url=new URL(window.location.href);return url.searchParams.get(name);} 
    const id = getQueryParam('id');
    const el = document.getElementById('manageDetails');

    if(!id){ 
      el.innerHTML = '<div class="alert alert-warning">No booking reference provided.</div>'; 
    } else {
      fetch(`http://localhost:3000/api/bookings/booking/${id}`)
        .then(response => response.json())
        .then(booking => {
          if (booking.message) {
            el.innerHTML = `<div class="alert alert-danger">${booking.message}</div>`;
            return;
          }
          el.innerHTML = `
            <div class="card p-3">
              <h5>Edit Booking: #REF${booking._id}</h5>
              <form id="manageForm">
                <div class="mb-3">
                  <label class="form-label">Temple</label>
                  <input type="text" class="form-control" id="temple" value="${booking.bookingDetails.temple}" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Date</label>
                  <input type="date" class="form-control" id="date" value="${booking.bookingDetails.date}" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Time</label>
                  <input type="text" class="form-control" id="time" value="${booking.bookingDetails.time}" required>
                </div>
                <button type="submit" class="btn btn-primary">Update Booking</button>
                <button type="button" class="btn btn-danger" id="cancelBtn">Cancel Booking</button>
              </form>
            </div>`;

          document.getElementById('manageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const updatedDetails = {
              temple: document.getElementById('temple').value,
              date: document.getElementById('date').value,
              time: document.getElementById('time').value,
            };

            fetch(`http://localhost:3000/api/bookings/booking/${id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ bookingDetails: updatedDetails }),
            })
            .then(response => response.json())
            .then(data => {
              if (data.message === 'Booking updated successfully') {
                alert('Booking updated successfully!');
                location.href = 'my-bookings.html';
              } else {
                alert('Error updating booking: ' + data.message);
              }
            });
          });

          document.getElementById('cancelBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel this booking?')) {
              fetch(`http://localhost:3000/api/bookings/booking/${id}`, {
                method: 'DELETE',
              })
              .then(response => response.json())
              .then(data => {
                if (data.message === 'Booking deleted successfully') {
                  alert('Booking cancelled successfully!');
                  location.href = 'my-bookings.html';
                } else {
                  alert('Error cancelling booking: ' + data.message);
                }
              });
            }
          });
        })
        .catch(error => {
          console.error('Error fetching booking details:', error);
          el.innerHTML = '<div class="alert alert-danger">Could not load booking details. Please try again later.</div>';
        });
    }
  </script>
</body>
</html>
